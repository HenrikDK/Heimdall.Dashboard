<template id="pod-logs">
  <div class="pl-2 pr-4 w-100">
    <div class="flex my-2 items-center justify-between">
      <span class="text-gray-500 dark:text-gray-300 text-2xl font-light sans">Pod Logs / {{ $route.params.namespace }} / {{ $route.params.name }}</span>
      
      <div id="controls" class="me-2 flex">
        <div v-if="direction == 'down'" @@click="direction = 'up'" class="flex px-2 mx-2 rounded-lg items-center justify-center border cursor-pointer
                    border-gray-300 hover:border-gray-500 hover:bg-gray-100 fill-gray-300 hover:fill-gray-500
                    dark:border-white/[.4] dark:text-white/[.6] 
                    dark:hover:border-white dark:hover:text-white dark:hover:fill-white
                    dark:bg-zinc-900">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mx-2 my-1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
          </svg>
        </div>
        <div v-else @@click="direction = 'down'" class="flex px-2 mx-2 rounded-lg items-center justify-center border cursor-pointer
                    border-gray-300 hover:border-gray-500 hover:bg-gray-100 fill-gray-300 hover:fill-gray-500
                    dark:border-white/[.4] dark:text-white/[.6] 
                    dark:hover:border-white dark:hover:text-white dark:hover:fill-white
                    dark:bg-zinc-900">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mx-2 my-1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0-3.75-3.75M17.25 21 21 17.25" />
          </svg>
        </div>
        
        <div @@click="downloadLog" class="flex px-2 rounded-lg items-center justify-center border cursor-pointer
            border-gray-300 hover:border-gray-500 hover:bg-gray-100 fill-gray-300 hover:fill-gray-500
            dark:border-white/[.4] dark:text-white/[.6] 
            dark:hover:border-white dark:hover:text-white dark:hover:fill-white
            dark:bg-zinc-900">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mx-2 my-1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/>
          </svg>
        </div>
      </div>
    </div>
    
    <div id="content">
      <div class="pl-2 border cursor-text font-mono text-xs rounded-md h-[85vh]
            border-gray-300
            dark:border-zinc dark:bg-black dark:border-white/[.4] dark:text-white/[.9]">
        <div v-if="logEvents.length == 0" 
             class="justify-center w-full flex py-2">
          <spinner></spinner>
        </div>
        <div v-else>
          <pre v-for="e in logEvents">{{ e }}</pre>
        </div>
      </div>
    </div>
    
  </div>
</template>

<script type="module">
import { useRoute } from 'vue-router';
import { ref, watch, onMounted } from 'vue'

let setup = (props, ctx) => {
  const route = useRoute();
  const sort = ref('desc');
  const logs = ref([]);
  const direction = ref('down')
  const logEvents = ref([]);

  let updateLogs = (j) => {
    let result = logEvents.value.concat(j)
    
    if (result.length > 1000){
      result = result.slice(-1000)
    }
    
    logEvents.value = result
  }
    
  onMounted(async () => {
    var host = window.location.origin;
    let namespace = route.params.namespace;
    let name = route.params.name;
    let container = route.params.container;
    
    const url = `/k8s/api/v1/namespaces/${namespace}/pods/${name}/log?container=${container}&previous=false&tailLines=1000&follow=true`;
    streamLogs(host + url, updateLogs);
  });
  
  return {
    sort, logs, logEvents, direction,
    updateLogs
  }
}

components["pod-logs"] = { template: "#pod-logs", props: ['search'], setup };
routes.push({path:'/namespace/:namespace/pods/:name/containers/:container/logs', name:'pod-logs', component: components["pod-logs"]})    
</script>
