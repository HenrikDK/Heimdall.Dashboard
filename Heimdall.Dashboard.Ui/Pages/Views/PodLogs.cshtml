<template id="pod-logs">
  <div class="pl-2 pr-4 w-100">
    <div class="flex my-2 items-center justify-between">
      <span class="text-gray-500 dark:text-gray-300 text-2xl font-light sans">Pod Logs / {{ $route.params.namespace }} / {{ $route.params.name }}</span>
      
      <div id="controls" class="me-2 flex">
        <scroll-direction-btn></scroll-direction-btn>

        <download-btn></download-btn>
      </div>
    </div>
    
    <div id="content">
      <div class="pl-2 border cursor-text font-mono text-xs rounded-md h-[85vh]
            border-gray-300
            dark:border-zinc dark:bg-black dark:border-white/[.4] dark:text-white/[.9]">
        <div v-if="logEvents.length == 0" 
             class="justify-center w-full flex py-2">
          <spinner></spinner>
        </div>
        <div v-else>
          <pre v-for="e in logEvents">{{ e }}</pre>
        </div>
      </div>
    </div>
    
  </div>
</template>

<script type="module">
import { useRoute } from 'vue-router';
import { ref, watch, onMounted } from 'vue'

let setup = (props, ctx) => {
  const route = useRoute();
  const sort = ref('desc');
  const logs = ref([]);
  const direction = ref('down')
  const logEvents = ref([]);

  let updateLogs = (j) => {
    let result = logEvents.value.concat(j)
    
    if (result.length > 1000){
      result = result.slice(-1000)
    }
    
    logEvents.value = result
  }
    
  onMounted(async () => {
    var host = window.location.origin;
    let namespace = route.params.namespace;
    let name = route.params.name;
    let container = route.params.container;
    
    const url = `/k8s/api/v1/namespaces/${namespace}/pods/${name}/log?container=${container}&previous=false&tailLines=1000&follow=true`;
    streamLogs(host + url, updateLogs);
  });
  
  return {
    sort, logs, logEvents, direction,
    updateLogs
  }
}

components["pod-logs"] = { template: "#pod-logs", props: ['search'], setup };
routes.push({path:'/namespace/:namespace/pods/:name/containers/:container/logs', name:'pod-logs', component: components["pod-logs"]})    
</script>
