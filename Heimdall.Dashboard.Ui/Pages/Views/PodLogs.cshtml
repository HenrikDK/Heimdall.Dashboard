<template id="pod-logs">
  <div class="pl-2 pr-4 w-100">
    <div class="flex my-2 items-center justify-between">
      <span class="text-gray-500 dark:text-gray-300 text-2xl font-light sans">Pod Logs / {{ $route.params.namespace }} / {{ $route.params.name }}</span>
      
      <log-controls :direction="direction" :wrap="wrap" @@direction="(d) => direction = d" @@wrap="(w) => wrap = w"></log-controls>
    </div>
    
    <log-viewer :events="logEvents" :wrap="wrap" :direction="direction"></log-viewer>
  </div>
</template>

<script type="module">
import { useRoute } from 'vue-router';
import { ref, watch, onMounted } from 'vue'

let setup = (props, ctx) => {
  const route = useRoute();
  const direction = ref('up');
  const wrap = ref(true);

  const logEvents = ref([]);

  let updateLogs = (j) => {
    let result = logEvents.value.concat(j)
    
    if (result.length > 1000){
      result = result.slice(-1000)
    }
    
    logEvents.value = result
  }
  
  onMounted(async () => {
    var host = window.location.origin;
    let namespace = route.params.namespace;
    let name = route.params.name;
    let container = route.params.container;
    
    const url = `/k8s/api/v1/namespaces/${namespace}/pods/${name}/log?container=${container}&previous=false&tailLines=1000&follow=true`;
    streamLogs(host + url, updateLogs);
  });
  
  return {
    logEvents, updateLogs, direction, wrap
  }
}

components["pod-logs"] = { template: "#pod-logs", props: ['search'], setup };
routes.push({path:'/namespace/:namespace/pods/:name/containers/:container/logs', name:'pod-logs', component: components["pod-logs"]})    
</script>
